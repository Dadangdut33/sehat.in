<!DOCTYPE html>
{% load static %}
{% load space_to_dash %}

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ post.title }}</title>

    <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
    <script type="text/javascript" src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
</head>
<body>
    {% include 'templates/header.html' %}

    <div class="post">
        <h1>{{ post.title }}</a></h1>
        <p>Tag: <a href="/forum/tag/{{ post.tag.name|space_to_dash }}">{{ post.tag.name }}</a></p>
        {% autoescape off %}
        {{ post.content }}
        {% endautoescape %}
        <p> Author: {% if post.user == null %}deleted{% else %}{{ post.user }}{% endif %} - Created at {{ post.created_at }} - last updated at {{ post.updated_at }}</p>
        <p>Likes <span id="post-like-count">{{ likes|length }}</span></p>
        <p>Liked by: 
            <span id="post-liker">
            {% for user in likes %}
            {{ user.user }}
            {% endfor %}
            </span>
        </p>
        <button class="button like" onclick="likePost('{{ user.is_authenticated }}', '{{ post.id }}', '{{ post.title }}', '{{ csrf_token }}')">Like</button>
        
        {% if post.user.id == user.id %}
            <button class="button edit" onclick="editPost('{{ user.is_authenticated }}', '{{ post.id }}', '{{ post.title }}')">Edit</button>
            <button class="button delete" onclick="deletePost('{{ user.is_authenticated }}', '{{ post.id }}', '{{ post.title }}', '{{ csrf_token }}', 'user')">Delete</button>
        {% else %}
            <button class="button report" onclick="reportPost('{{ user.is_authenticated }}', '{{ post.id }}', '{{ post.title }}', '{{ csrf_token }}')">Report</button>
        {% endif %}
        {% if user.is_staff %}
            <button onclick="deletePost('{{ user.is_authenticated }}', '{{ post.id }}', '{{ post.title }}', '{{ csrf_token }}', 'admin')">Delete (Admin Mode)</button>
        {% endif %}
    </div>

    <div class="comment-form">
        <div id="editor"></div>
        {% if user.is_authenticated %}
            <button type="submit" onclick="comment('{{ user.is_authenticated }}', '{{ post.id }}', '{{ post.title }}', '{{ csrf_token }}')">Submit</button>
        {% else %}
            <button type="submit" onclick="comment('{{ user.is_authenticated }}', '{{ post.id }}', '{{ post.title }}', '{{ csrf_token }}')" disabled>Submit</button>
        {% endif %}
    </div>

    <div class="comment-box">
        <h2>Comments (<span id="comment-counter">{{ comments|length }}</span>)</h2>
        <ul>
            {% for comment in comments %}
            <li class="comment" id="comments-{{ comment.id }}">
                <span id="fill-{{ comment.id }}">
                    <div style="max-width: 800px;" id="comment-{{comment.id}}">
                        {% autoescape off %}
                        {{ comment.content }}
                        {% endautoescape %}
                    </div>
                </span>

                <p>Likes: <span id="comment-like-count-{{ comment.id }}"> {{ comment.likes }}</p>

                {% if comment.user == null %}
                <p>Author: <a href="/profile/deleted">deleted</a> - Created at {{ comment.created_at }} - last updated at {{ comment.updated_at }}</p>
                {% else %}
                <p>Author: <a href="/profile/{{ comment.user.username }}">{{ comment.user.username }}</a> ({{ comment.user.first_name }} {{ comment.user.last_name }}) - Created at {{ comment.created_at }} - last updated at {{ comment.updated_at }}</p>
                {% endif %}
                
                <button onclick="likeComment('{{ user.is_authenticated }}', '{{ post.id }}', '{{ post.title }}', '{{ comment.id }}', '{{ csrf_token }}')">Like</button>
                {% if comment.user.id == user.id %}
                <button onclick="deleteComment('{{ user.is_authenticated }}', '{{ post.id }}', '{{ post.title }}', '{{ comment.id }}', '{{ csrf_token }}', 'user')">Delete</button>
                <button onclick="editComment('{{ user.is_authenticated }}', '{{ post.id }}', '{{ post.title }}', '{{ comment.id }}', '{{ csrf_token }}')">Edit</button>
                {% endif %}
                {% if not comment.user.id == user.id %}
                <button onclick="reportComment('{{ user.is_authenticated }}', '{{ post.id }}', '{{ post.title }}', '{{ comment.id }}', '{{ csrf_token }}')">Report</button>
                {% endif %}
                {% if user.is_staff %}
                <button onclick="deleteComment('{{ user.is_authenticated }}', '{{ post.id }}', '{{ post.title }}', '{{ comment.id }}', '{{ csrf_token }}', 'admin')">Delete (Admin Mode)</button>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        var myToolbar= [
            ['bold', 'italic', 'underline', 'strike'],       
            ['blockquote', 'code-block'],

            [{ 'color': [] }, { 'background': [] }],         
            [{ 'font': [] }],
            [{ 'align': [] }],

            ['clean'],                                        
            ['image']
        ];

        function imageHandler() {
            var range = this.quill.getSelection();
            var value = prompt('please copy paste the image url here.');
            if(value){
                this.quill.insertEmbed(range.index, 'image', value, Quill.sources.USER);
            }
        }
    </script>
    {% if user.is_authenticated %}
    <script>
        var quill = new Quill('#editor', {
            theme: 'snow',
            placeholder: 'Submit a comment',
            modules: {
                toolbar: {
                    container: myToolbar,
                    handlers: {
                        image: imageHandler
                    }
                }
            },
        });
    </script>
    {% else %}
    <script>
        var quill = new Quill('#editor', {
            theme: 'snow',
            placeholder: 'Login to submit a comment',
            readOnly: true,
            modules: {
                toolbar: {
                    container: myToolbar,
                    handlers: {
                        image: imageHandler
                    }
                }
            },
        });
    </script>
    {% endif %}
    <script type="text/javascript" src="{% static 'js/forumHandler.js' %}"></script>


    {% include 'templates/footer.html' %}
</body>
</html>